name: deploy-backend

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 코드 가져오기
      - uses: actions/checkout@v4

      # 2️⃣ Java 설정
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ AWS 자격증명 설정
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<account>:role/tguard-oidc-role
          aws-region: <region>

      # 4️⃣ Gradle 실행 권한 부여 (Windows 체크아웃 문제 방지)
      - run: chmod +x gradlew

      # 5️⃣ Gradle 캐시 초기화
      - run: ./gradlew clean

      # 6️⃣ 빌드
      - run: ./gradlew test bootJar

      # 7️⃣ Docker 이미지 생성 및 태그
      - run: |
          docker build -t tguard-backend .
          docker tag tguard-backend <account>.dkr.ecr.<region>.amazonaws.com/tguard-backend:${{ github.sha }}

      # 8️⃣ ECR 로그인 & 푸시
      - run: |
          aws ecr get-login-password --region <region> \
            | docker login --username AWS --password-stdin <account>.dkr.ecr.<region>.amazonaws.com
          docker push <account>.dkr.ecr.<region>.amazonaws.com/tguard-backend:${{ github.sha }}

      # 9️⃣ EC2 배포 (SSM 사용)
      - run: |
          aws ssm send-command \
            --instance-ids "<ec2-instance-id>" \
            --document-name "AWS-RunShellScript" \
            --comment "deploy $GITHUB_SHA" \
            --parameters commands='[
              "set -e",
              "docker pull <account>.dkr.ecr.<region>.amazonaws.com/tguard-backend:${GITHUB_SHA}",
              "docker stop tguard || true",
              "docker rm tguard || true",
              "docker run -d --name tguard --restart unless-stopped -p 8080:8080 --env-file /opt/tguard/.env <account>.dkr.ecr.<region>.amazonaws.com/tguard-backend:${GITHUB_SHA}"
            ]'
